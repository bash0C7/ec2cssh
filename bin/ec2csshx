#!/usr/bin/env ruby

servers_name_pattern = ARGV.shift
raise unless servers_name_pattern

ec2ssh_update_command = ARGV.shift
ec2ssh_update_command ||= 'ec2ssh update'

cssh_command = ARGV.shift
cssh_command ||= 'csshx'

port = ARGV.shift
port = port.nil? ? '' : port + ':' 

ec2ssh_update_result = `#{ec2ssh_update_command}`
puts ec2ssh_update_command
puts ec2ssh_update_result
puts

servers = ec2ssh_update_result.scan(/^Host\s(#{servers_name_pattern})/).flatten.join(' ')
puts servers_name_pattern
puts servers
puts

puts "#{cssh_command} #{servers}"
puts `#{cssh_command} #{servers}`
